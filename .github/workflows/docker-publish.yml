name: Monitor and Publish BeamMP-Server

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:        # Manual trigger

jobs:
  check-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Get latest release from BeamMP/BeamMP-Server
        id: get-release
        run: |
          curl -s https://api.github.com/repos/BeamMP/BeamMP-Server/releases/latest \
            | jq -r .tag_name > latest-upstream-tag.txt
          echo "Latest upstream tag: $(cat latest-upstream-tag.txt)"

      - name: Load previously built tag
        id: get-previous
        run: |
          echo "previous-tag=none" >> $GITHUB_OUTPUT
          if [ -f .beammp-latest ]; then
            echo "Found previous tag: $(cat .beammp-latest)"
            echo "previous-tag=$(cat .beammp-latest)" >> $GITHUB_OUTPUT
          fi

      - name: Compare tags
        id: compare-tags
        run: |
          upstream=$(cat latest-upstream-tag.txt)
          previous="${{ steps.get-previous.outputs.previous-tag }}"
          echo "upstream=$upstream" >> $GITHUB_OUTPUT
          echo "previous=$previous" >> $GITHUB_OUTPUT
          if [ "$upstream" != "$previous" ]; then
            echo "new-release=true" >> $GITHUB_OUTPUT
          else
            echo "new-release=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no new release
        if: steps.compare-tags.outputs.new-release == 'false'
        run: echo "No new release. Exiting."

      - name: Clone BeamMP-Server
        if: steps.compare-tags.outputs.new-release == 'true'
        run: |
          git clone --depth 1 --branch "${{ steps.compare-tags.outputs.upstream }}" https://github.com/BeamMP/BeamMP-Server.git

      - name: Log in to GitHub Container Registry
        if: steps.compare-tags.outputs.new-release == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: steps.compare-tags.outputs.new-release == 'true'
        run: |
          cd BeamMP-Server
          IMAGE=ghcr.io/${{ github.repository_owner }}/beammp-server
          TAG=${{ steps.compare-tags.outputs.upstream }}

          docker build -t $IMAGE:$TAG .
          docker push $IMAGE:$TAG

          docker tag $IMAGE:$TAG $IMAGE:latest
          docker push $IMAGE:latest

      - name: Save current tag
        if: steps.compare-tags.outputs.new-release == 'true'
        run: |
          echo "${{ steps.compare-tags.outputs.upstream }}" > .beammp-latest
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .beammp-latest
          git commit -m "Update last built release tag to ${{ steps.compare-tags.outputs.upstream }}"
          git push
